# Go语言手写简单的Web框架

此项目学习了[教程](https://geektutu.com/post/gee.html)，模仿Gin实现一个简单的Web框架，重在了解Web框架，我也借此熟悉一下Golang

## Handler接口

Golang的Web框架都是基于Go的net/http库实现的，主要涉及路由注册、请求处理和服务启动三个功能。
其中服务启动调用了http.ListenAndServe函数，该函数接受一个监听端口号以及一个实现了ServeHTTP方法的结构(路由)，在服务运行时通过ServeHTTP方法来解析请求路径并执行对应的处理函数

## 上下文Context

Web服务无非是根据请求{*http.Request}来构造响应{http.ResponseWriter}。我们要构造一个完整的响应需要考虑消息头和消息体等细节信息，如果不进行有效的封装那么需要重复写大量繁杂的代码，因此使用上下文来封装这两个结构。

而上下文除了封装上面两个结构体之外，还可用于支撑额外的功能。

## 动态路由

动态路由即一条路由规则可以匹配某一类型而非某一条固定的路由。实现动态路由最常用的数据结构是前缀树。

路由最重要的是注册和匹配，对应前缀树的插入和查询。每一个URL对应前缀树上从根节点往下的一条路径，且只有在路径的最后一个节点在保存着这个完整的URL，中间节点不保存。
不同的请求方式有自己的前缀树。

为了实现动态路由，需要占用更多的内存空间。因为原本只用一个map映射每个URL到对应的handler即可，现在还需要存储整棵前缀树，空间上和时间上的开销都增加了。

## 分组控制

分组控制（Group Control）是Web框架应提供的基础功能之一。分组指的是路由分组，因为在真实的业务场景中往往某一组路由需要相似的处理。比如：
以/post开头的路由可匿名访问；
以/admin开头的路由需要鉴权
以/api开头的路由是RESTful接口，可以对接第三方平台，需要三方平台鉴权。

大部分情况下的路由分组是以相同的路由前缀来区分的，并且支持分组嵌套。作用在某个分组上的中间件也应该会作用在其子分组之上。

分组对象需要具备的属性和功能：

1. 前缀
2. 存储中间件
3. 父分组
4. 往分组添加路由的能力

并将所有和路由有关的功能转由分组实现。

## 中间件

Web框架本身不可能实现所有的业务功能，因此需要一个插口来允许用户自定义功能并嵌入到框架中。框架对中间件的支持需要考虑：

1. 中间件插入点的位置：使用框架的用户并不关心框架的底层实现逻辑，所以中间件的插入点不能太底层。但也不能太“表面”，否则与用户自定义函数没多大区别。所以中间件的插入点一般是在**框架接收到请求初始化Context对象后**，允许用户使用自己定义的中间件做一些额外的处理，以及对Context进行二次加工。
2. 中间件的输入：决定了中间件的扩展能力，如果暴露的参数太少则用户的发挥空间有限。

中间件是应用在分组（RouterGroup）上的，应用在最顶层的Group相当于作用于全局，所有的请求都会被中间件处理。如果中间件是作用在一条路由规则上，那不如直接在路由规则对应的Handler中实现功能。

中间件不仅可以作用在处理流程前，也可以作用在处理流程后，所以要在Context中保存中间件然后依次调用。

## 模板

前后端分离的开发模式：Web后端提供RESTful接口，返回结构化的数据(通常是JSOn或者XML)。前端使用AJAX请求到所需的数据，利用JavaScript进行渲染。这样可以让同一套后端服务同时支撑小程序、移动APP、web页面以及对外提供接口。但前后端分离的一大问题在于页面是在客户端渲染的，这对于爬虫并不友好，短期内爬取服务端直接渲染的HTML页面仍然是主流。所以一般web框架会提供支持服务端渲染的功能。

静态文件的请求：解析URL得到要获取的静态文件的地址，找到真实的文件后返回即可。文件的返回在golang的net/http库已经实现(http.FileServer)。

golang内置了两个模板标准库text/template和html/template，其中html/template提供了对HTML较为完整的支持，包括普通变量渲染、列表渲染、对象渲染等。可以使用这个标准库来实现对模板的支持。

## 错误处理机制

一个Web框架需要有错误处理机制，如果没有，在代码中存在触发panic的BUG的话服务器很容易宕机。

一个简单的错误处理机制是在错误发生时向用户返回Internal Server Error并且在日志中打印必要的错误信息，方便进行错误定位。错误处理也可以作为一个中间件。
